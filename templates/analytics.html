{% extends "base.html" %}

{% block title %}Analytics - VPN Panel{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="analytics-header">
        <h1><i class="fas fa-chart-bar"></i> Traffic Analytics</h1>
        <div class="period-selector">
            <label for="period-select">Period:</label>
            <select id="period-select" onchange="loadAnalytics()">
                <option value="1h">Last Hour</option>
                <option value="6h">Last 6 Hours</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
            </select>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="card-icon">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="card-content">
                <h3 id="total-traffic">0 GB</h3>
                <p>Total Traffic</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="card-content">
                <h3 id="total-connections">0</h3>
                <p>Total Connections</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="card-content">
                <h3 id="avg-bandwidth">0 Mbps</h3>
                <p>Average Bandwidth</p>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="card-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-content">
                <h3 id="peak-bandwidth">0 Mbps</h3>
                <p>Peak Bandwidth</p>
            </div>
        </div>
    </div>

    <!-- Traffic Charts -->
    <div class="charts-container">
        <div class="chart-card">
            <h3>Traffic by Hour</h3>
            <canvas id="hourly-chart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-card">
            <h3>Top Clients</h3>
            <canvas id="clients-chart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Top Lists -->
    <div class="lists-container">
        <div class="list-card">
            <h3>Top Clients by Traffic</h3>
            <div id="top-clients-list" class="data-list">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <div class="list-card">
            <h3>Top Servers by Traffic</h3>
            <div id="top-servers-list" class="data-list">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <h3>Export Data</h3>
        <div class="export-controls">
            <input type="date" id="start-date" />
            <input type="date" id="end-date" />
            <select id="export-format">
                <option value="json">JSON</option>
                <option value="csv">CSV</option>
            </select>
            <button onclick="exportData()" class="btn btn-primary">Export</button>
        </div>
    </div>
</div>

<script>
let hourlyChart = null;
let clientsChart = null;

// Load analytics data
async function loadAnalytics() {
    const period = document.getElementById('period-select').value;
    
    try {
        const response = await fetch(`/api/analytics/summary?period=${period}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load analytics');
        }
        
        const data = await response.json();
        updateAnalyticsDisplay(data);
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification('Error loading analytics data', 'error');
    }
}

// Update analytics display
function updateAnalyticsDisplay(data) {
    // Update summary cards
    document.getElementById('total-traffic').textContent = formatBytes(data.total_traffic);
    document.getElementById('total-connections').textContent = data.total_connections;
    document.getElementById('avg-bandwidth').textContent = `${data.avg_bandwidth.toFixed(2)} Mbps`;
    document.getElementById('peak-bandwidth').textContent = `${data.peak_bandwidth.toFixed(2)} Mbps`;
    
    // Update hourly chart
    updateHourlyChart(data.traffic_by_hour);
    
    // Update clients chart
    updateClientsChart(data.top_clients);
    
    // Update top lists
    updateTopClientsList(data.top_clients);
    updateTopServersList(data.top_servers);
}

// Update hourly traffic chart
function updateHourlyChart(trafficByHour) {
    const ctx = document.getElementById('hourly-chart').getContext('2d');
    
    if (hourlyChart) {
        hourlyChart.destroy();
    }
    
    const labels = trafficByHour.map(item => `${item.hour}:00`);
    const data = trafficByHour.map(item => item.total_traffic / (1024 * 1024 * 1024)); // Convert to GB
    
    hourlyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Traffic (GB)',
                data: data,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Traffic (GB)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Hour'
                    }
                }
            }
        }
    });
}

// Update clients chart
function updateClientsChart(topClients) {
    const ctx = document.getElementById('clients-chart').getContext('2d');
    
    if (clientsChart) {
        clientsChart.destroy();
    }
    
    const labels = topClients.map(client => client.client_id.substring(0, 8));
    const data = topClients.map(client => client.total_traffic / (1024 * 1024 * 1024)); // Convert to GB
    
    clientsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40',
                    '#FF6384',
                    '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Update top clients list
function updateTopClientsList(topClients) {
    const container = document.getElementById('top-clients-list');
    container.innerHTML = '';
    
    topClients.forEach((client, index) => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <div class="item-rank">${index + 1}</div>
            <div class="item-info">
                <div class="item-name">${client.client_id}</div>
                <div class="item-details">
                    Traffic: ${formatBytes(client.total_traffic)} | 
                    Connections: ${client.connection_count}
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Update top servers list
function updateTopServersList(topServers) {
    const container = document.getElementById('top-servers-list');
    container.innerHTML = '';
    
    topServers.forEach((server, index) => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <div class="item-rank">${index + 1}</div>
            <div class="item-info">
                <div class="item-name">${server.server_id}</div>
                <div class="item-details">
                    Traffic: ${formatBytes(server.total_traffic)} | 
                    Clients: ${server.unique_clients}
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Export data
async function exportData() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const format = document.getElementById('export-format').value;
    
    if (!startDate || !endDate) {
        showNotification('Please select start and end dates', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/analytics/export?start_date=${startDate}&end_date=${endDate}&format=${format}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Export failed');
        }
        
        const data = await response.text();
        
        // Download file
        const blob = new Blob([data], { type: format === 'json' ? 'application/json' : 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vpn-analytics-${startDate}-${endDate}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Data exported successfully', 'success');
        
    } catch (error) {
        console.error('Error exporting data:', error);
        showNotification('Error exporting data', 'error');
    }
}

// Utility function to format bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Initialize analytics page
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates for export
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = lastMonth.toISOString().split('T')[0];
    
    // Load initial analytics
    loadAnalytics();
});
</script>

<style>
.analytics-dashboard {
    padding: 20px;
}

.analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.period-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.period-selector label {
    font-weight: bold;
    color: #333;
}

.period-selector select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.summary-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.card-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.card-content h3 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.card-content p {
    margin: 5px 0 0 0;
    color: #666;
    font-size: 14px;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-card h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.lists-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.list-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.list-card h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.data-list {
    max-height: 300px;
    overflow-y: auto;
}

.list-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.list-item:last-child {
    border-bottom: none;
}

.item-rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.item-details {
    font-size: 12px;
    color: #666;
}

.export-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.export-section h3 {
    margin: 0 0 20px 0;
    color: #333;
}

.export-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.export-controls input,
.export-controls select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
}

.export-controls button {
    padding: 8px 16px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.export-controls button:hover {
    background: #5a6fd8;
}
</style>
{% endblock %} 